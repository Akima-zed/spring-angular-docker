version: "3.9"

services:
  # Service 1 : Application Spring Boot (API backend)
  backend:
    # Construit l'image depuis le Dockerfile du répertoire courant
    build: .

    # Mapping des ports : [port_local]:[port_conteneur]
    # localhost:8080 redirige vers le port 8080 du conteneur
    ports:
      - "8080:8080"

    # Variables d'environnement passées au conteneur Spring Boot
    # Spring les lit automatiquement pour se connecter à la base de données
    environment:
      # URL de connexion : "db" est le nom du service PostgreSQL (résolu automatiquement par Docker)
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/workshopsdb
      SPRING_DATASOURCE_USERNAME: workshops_user
      SPRING_DATASOURCE_PASSWORD: oc2024

    # Dépendance : attend que le service "db" soit démarré avant de lancer backend
    depends_on:
      - db

    # Vérifie régulièrement que l'application fonctionne
    # Teste l'endpoint /actuator/health toutes les 10 secondes
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      retries: 5

  # Service 2 : Base de données PostgreSQL
  db:
    # Utilise l'image officielle PostgreSQL version 13
    image: postgres:13

    # Configuration de la base de données
    environment:
      POSTGRES_USER: workshops_user # Nom d'utilisateur créé automatiquement
      POSTGRES_PASSWORD: oc2024 # Mot de passe
      POSTGRES_DB: workshopsdb # Nom de la base créée automatiquement

    # Expose le port PostgreSQL (optionnel, utile pour se connecter depuis l'extérieur)
    ports:
      - "5432:5432"

    # Volume pour persister les données
    # Les données PostgreSQL sont sauvegardées même si le conteneur est supprimé
    volumes:
      - pgdata:/var/lib/postgresql/data

# Déclaration du volume pour stocker les données PostgreSQL
volumes:
  pgdata:
